# PWL-MORE nginx vhost — DO NOT reuse ports 1935 or 8080 (radio)
# VPS: 72.60.181.89

limit_req_zone $binary_remote_addr zone=more_auth:10m rate=5r/m;

server {
    listen 80;
    server_name more.peoplewelike.club;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name more.peoplewelike.club;

    # Use same certs as radio (Cloudflare origin or Let's Encrypt)
    ssl_certificate     /etc/ssl/certs/cf-origin.pem;
    ssl_certificate_key /etc/ssl/private/cf-origin.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    client_max_body_size 10m;

    # Root → redirect to radio
    location = / {
        return 302 https://radio.peoplewelike.club/;
    }

    # Rate-limit auth
    location ~ ^/more/[^/]+/login$ {
        limit_req zone=more_auth burst=3 nodelay;
        proxy_pass http://127.0.0.1:3100;
        include /etc/nginx/proxy_params_more;
    }
    location ~ ^/more/[^/]+/reset {
        limit_req zone=more_auth burst=3 nodelay;
        proxy_pass http://127.0.0.1:3100;
        include /etc/nginx/proxy_params_more;
    }

    # Static uploads
    location /uploads/ {
        alias /var/lib/pwl-more/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Next.js
    location /more/ { proxy_pass http://127.0.0.1:3100; include /etc/nginx/proxy_params_more; }
    location /_next/ { proxy_pass http://127.0.0.1:3100; include /etc/nginx/proxy_params_more; expires 1y; add_header Cache-Control "public, immutable"; }
    location /health  { proxy_pass http://127.0.0.1:3100; include /etc/nginx/proxy_params_more; }
    location /api/    { proxy_pass http://127.0.0.1:3100; include /etc/nginx/proxy_params_more; }

    location / { return 404; }
}
