# Session Log: 2026-02-20

## Objective
Admin system, invite flow, pincode change UX, admin bar, and oscarzillini email fix.

## Tasks Completed

### A. Reconcile Card Email
- oscarzillini card email was `oscar@peoplewelike.club`
- Updated via psql: `UPDATE cards SET email='ged.zilius@gmail.com' WHERE username='oscarzillini'`

### B. Global Admin System (/admin)
- Added `ADMIN_EMAIL` + `ADMIN_PASSWORD` env vars to `.env`
- Admin auth: plaintext constant-time comparison via `crypto.timingSafeEqual`
- New files: `src/lib/admin-session.ts`, `src/app/admin/`, `src/app/api/admin/*`
- Admin session cookie: `pwl-admin-session` (iron-session, 8h TTL)

### C. Registration Option B (Invite Links)
- Added `invites` table to Postgres
- Admin creates invite → `/invite/<token>` URL
- Friend opens URL, sets username+pincode+displayName → card created, session set
- Files: `src/app/invite/[token]/`, `src/app/api/invite/[token]/route.ts`

### D. Pincode Change UX
- New API: `POST /api/card/[username]/pincode` (requires card session)
- Added "Security" tab to user AdminDashboard with change-pincode form + reset link

### E. Admin Bar
- `src/app/AdminBar.tsx`: client component, polls `/api/admin/me`, shows sticky bar when admin is logged in
- Shows "Admin Panel →" link sitewide when admin session active

### F. Docs
- STATUS.md, docs/ADMIN_PROVISIONING.md, docs/OPERATIONS.md created

## Key Errors and Fixes

### bcrypt hash dollar signs corrupted by docker compose
- Bcrypt hashes contain `$` which docker compose interpolates as env var references
- Fix: switched to `ADMIN_PASSWORD` (plaintext) + `crypto.timingSafeEqual` constant-time comparison

### `sendEmail` not exported from email.ts
- email.ts only had `sendRegistrationEmail` and `sendResetEmail`
- Fix: added generic `sendEmail({ to, subject, html })` export

### git clean wiped .env on deploy dir reset
- Used `git reset --hard origin/main && git clean -fd` to fix merge conflict
- git clean removed `.env` (git-ignored file)
- Fix: manually recreated .env

## Verification Results (2026-02-20)

| Gate | Result |
|------|--------|
| /health | {"ok":true} |
| / root redirect | 307 → radio |
| /more/oscarzillini | 200 OK |
| /admin/login | 200 OK |
| POST /api/admin/login | {"ok":true} |
| GET /api/admin/me (authed) | {"isAdmin":true} |
| GET /admin (authed) | 200 OK |
| GET /api/admin/cards | oscarzillini card listed |
| POST /api/admin/invites | invite URL generated |
| /more/oscarzillini/login | 200 OK |
| POST /api/card/oscarzillini/pincode (unauthed) | 401 Unauthorized |
| radio containers (5) | All Up, untouched |
| pwl-more-app | healthy |
| pwl-more-db | healthy |

## Commits
- `738eb11` feat: admin panel, invite flow, pincode change, admin bar
- `329cb16` fix: add sendEmail helper, add env_file to docker-compose
- `d340e2a` fix: use ADMIN_PASSWORD plaintext with timingSafeEqual
